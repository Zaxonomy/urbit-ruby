require "urbit/ship"

describe Urbit::Api::Channel do
  before(:each) do
    @ship = Urbit::Api::Ship.new
    @c = @ship.open_channel "Test Channel"
  end

  after(:each) do
    @c.close if @c.open?
  end

  it "is initialized with a name" do
    expect(@c.name).to_not be_nil
    expect(@c.name).to     eq('Test Channel')
  end

  it "has an autogenerated key" do
    expect(@c.key).to_not be_nil
  end

  it "has a key 16 chars long" do
    expect(@c.key.size).to eq(16)
  end

  it "can send a message once opened" do
    expect(@c.sent_messages.size).to eq(1)
    expect(@c.open?)
  end

  it "can be closed" do
    expect(@c.sent_messages.size).to eq(1)
    expect(@c.close).to eq("ok")
    expect(@c.sent_messages.size).to eq(2)
    expect(@c.closed?)
  end

  it "can subscribe" do
    expect(@c.sent_messages.size).to eq(1)
    expect(s = @c.subscribe).to_not be_nil

    # Subscribing sends a message to the ship
    expect(@c.sent_messages.size).to eq(2)

    # Let's send a message to the channel?
    # m = Urbit::Api::Message.new @c, 3, "poke", "chat-view", "/primary", "Test Subscriber Message"
    # sleep(10)
  end
end

